# 처리율 제한 장치의 설계

처리율 제한 장치(rate limiter)는 클라이언트 또는 서비스가 보내는 트래픽의 처리율(rate)을 제어하기 위한 장치.

</br>
ex) 요청 횟수가 제한 장치에 정의된 임계치를 넘어서면 추가로 도달한 모든 호출은 처리가 중단된다.

- 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
- 같은 IP 주소로는 하루에 10개 이상의 계정을 생성할 수 없다.
- 같은 디바이스로는 주당 5회 이상의 리워드(rewards)를 요청할 수 없다.

## API에 처리율 제한 장치를 두면 좋은점
- DoS(Denial of Service) 공격에 의한 자원 고갈을 방지할 수 있다.
- 비용 절감
- 서버 과부하를 막는다

### 1단계 문제 이해 및 설계 범위의 확정 (요구사항)
- 설정된 처리율을 초과하는 요청은 정확하게 제한
- 낮은 응답시간 : 이 처리율 제한 장치는 HTTP 응답시간에 나쁜 영향을 주어서는 곤란하다
- 가능한 한 적은 메모리를 써야한다.
- 분산형 처리율 제한(distributed rate limiting) : 하나의 처리율 제한 장치를 여러 서버나 프로세스에 공유할 수 있어야한다.
- 예외 처리 : 요청이 제한이 되었을 때는 그 사실을 사용자에게 분명하게 보여줘야함.
- 높은 결함 감내성(fault tolerance): 제한 장치에 장애가 생기더라도 전체 시스템에 영향을 주어서는 안됨.

### 2단계 개략적 설계안 제시 및 동의 구하기
- 클라이언트 측에 둔다면
```
일반적으로 클라이언트는 처리율 제한을 안정적으로 걸 수 있는 장소가 못됨.
클라이언트 요청은 쉽게 위변조가 가능해서.
```
- 서버 측에 둔다면
```
처리율 제한 장치를 API 서버에 두는 대신, 처리율 제한 미들웨어를 만들어 해당 미들웨어로 하여금 API서버로 가능 요청 통제
```
![image](https://github.com/user-attachments/assets/5acfa8ee-bfb7-43d3-b8dd-489d0aa51d7f)

HTTP 상태코드 429는 사용자가 너무 많은 요청을 보내려고 했음(Too many requests)을 알린다.

![image](https://github.com/user-attachments/assets/c9069abd-42e1-4e9c-8f04-3b739de56810)

클라우드 마이크로서비스의 경우, 처리율 제한 장치는 보통 API 게이트웨이라 불리는 컴포넌트에 구현됨. </br>
API 게이트웨이는 처리율 제한, SSL종단, 사용자 인증, IP허용목록(whitelist)관리 등을 지원하는 완전 위탁관리형 서비스(fully managed), </br>
즉 클라우드 업체 유지 보수를 담당하는 서비스.

* 현재 기술스택이나 엔지니어링 인력, 우선순위, 목표에 따라 달라질 수 있음.

# 처리율 제한 알고리즘
1. 토큰 버킷(token bucket)
2. 누출 버킷(leaky bucket)
3. 고정 윈도 카운터(fixed window counter)
4. 이동 윈도 로그(sliding window log)
5. 이동 윈도 카운터(sliding window counter)

## 토큰 버킷 알고리즘
토큰 버킷 알고리즘은 처리율 제한에 폭넓게 이용되고 있음. 아마존과 스트라이프가 API 요청을 통제하기 위해 이 알고리즘을 사용.

```
 토큰 버킷은 지정된 용량을 갖는 컨테이너. 이 버킷에는 사전 설정된 양의 토큰이 주기적으로 채워진다.
이 버킷에는 사전 설정된 양의 토큰이 주기적으로 채워진다. 토큰이 꽉 찬 버킷에는 더 이상의 토큰은 추가되지 않는다.
토큰 공급기(refiller)는 이 버킷에 매초 2개의 토큰을 추가함. 버킷이 가득차면 추가로 공급된 토큰은 버려짐. (overflow)
```

![image](https://github.com/user-attachments/assets/9537bdc5-eb50-4b5a-8340-8ca9062258ec)


각 요청은 처리될 때마다 하나의 토큰을 사용함. 요청이 도착하면 버킷에 충분한 토큰이 있는지 검사함.

- 충분한 토큰이 있는 경우, 버킷에서 토큰 하나를 꺼낸 후 요청을 시스템에 전달함.
- 충분한 토큰이 없는 경우, 해당 요청은 버려짐(dropped)

토큰 버킷 알고리즘은 2개 인자(parameter)를 받음.
- 버킷 크기: 버킷에 담을 수 있는 토큰의 최대 개수
- 토큰 공급률(refill rate): 초당 몇 개의 토큰이 버킷에 공급되는가

> 통상적으로, API 엔드포인트(endpoint)마다 별도의 버킷을 둔다.

```
예를들어, 사용자마다 하루에 한번만 포스팅 가능, 친구는 150명 추가, 좋아요는 5번만 누를 수 있다면 사용자마다 3개의 버킷이 필요.
```

- 장점
1. 구현이 쉽다.
2. 메모리 사용 측면에서도 효율적이다.
3. 짧은 시간에 집중되는 트래픽(burst of traffic)도 처리 가능. 버킷에 남은 토큰이 있기만 하면 요청은 시스템에 전달됨.

- 단점
1. 이 알고리즘은 버킷 크기와 토큰 공급률이라는 두 개 인자를 가지고 있는데, 이 값을 적절하게 튜닝하는 것은 까다로운 일이 될 것임.







